<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      const app = {
        middlewares: []
      };

      app.use = function(fn) {
        app.middlewares.push(fn);
      };

      app.compose = function() {
        function dispatch(index) {
          if (index === app.middlewares.length) {
            return Promise.resolve();
          }
          let route = app.middlewares[index];
          return Promise.resolve(route(() => dispatch(++index)));
        }
        dispatch(0);
      };

      function compose(middleware) {
        if (!Array.isArray(middleware))
          throw new TypeError("Middleware stack must be an array!");
        for (const fn of middleware) {
          if (typeof fn !== "function")
            throw new TypeError("Middleware must be composed of functions!");
        }
        return function(context, next) {
          let index = -1;
          return dispatch(0);
          function dispatch(i) {
            if (i <= index) return;
            index = i;
            let route = middleware[i];
            if (i === middleware.length) route = next;
            if (!route) return Promise.resolve();
            try {
              return Promise.resolve(
                route(context, dispatch.bind(null, i + 1))
              );
            } catch (error) {
              return Promise.reject(error);
            }
          }
        };
      }

      // 异步函数
      function fn() {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            resolve();
            console.log("hello");
          }, 3000);
        });
      }

      app.use(async next => {
        console.log(1);
        await next();
        console.log(2);
      });

      app.use(async next => {
        console.log(3);
        await fn(); // 调用异步函数
        await next();
        console.log(4);
      });

      app.use(async next => {
        console.log(5);
        await next();
        console.log(6);
      });

      app.compose();
    </script>
  </body>
</html>
